{% extends "warehouse_app/base.html" %}

{% block title %}Поступления{% endblock %}

{% block content %}
<h1 class="mb-4">Поступления продукции</h1>

<!-- Кнопка "Оформить новое поступление" -->
<div class="mb-3">
    <a href="{% url 'productbatch_create' %}" class="btn btn-success">Оформить новую партию</a>
</div>

<!-- ВСЕ фильтры должны быть в одной форме -->
<form method="get" class="mb-4" id="filter-form">
    
    <!-- Строка поиска и кнопки -->
    <div class="row g-2 align-items-end mb-3">
        <div class="col-md-4">
            <input type="text" name="q" class="form-control"
                   placeholder="Поиск по номеру партии или номенклатуре"
                   value="{{ query }}">
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Найти</button>
            <a href="{% url 'productbatch_list' %}" class="btn btn-secondary">Сброс</a>
        </div>
    </div>
    
    <!-- Фильтры по датам -->
    <div class="row g-2 align-items-end mb-3">
        <div class="col-md-4">
            <label class="form-label small mb-1">Дата производства</label>
            <div class="row g-1">
                <div class="col">
                    <input type="date" name="start_production_date" class="form-control form-control-sm"
                           value="{{ start_production_date }}">
                </div>
                <div class="col-auto align-self-center">—</div>
                <div class="col">
                    <input type="date" name="end_production_date" class="form-control form-control-sm"
                           value="{{ end_production_date }}">
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <label class="form-label small mb-1">Дата приёмки</label>
            <div class="row g-1">
                <div class="col">
                    <input type="date" name="start_reception_date" class="form-control form-control-sm"
                           value="{{ start_reception_date }}">
                </div>
                <div class="col-auto align-self-center">—</div>
                <div class="col">
                    <input type="date" name="end_reception_date" class="form-control form-control-sm"
                           value="{{ end_reception_date }}">
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <label class="form-label small mb-1">Срок годности</label>
            <div class="row g-1">
                <div class="col">
                    <input type="date" name="start_expiration_date" class="form-control form-control-sm"
                           value="{{ start_expiration_date }}">
                </div>
                <div class="col-auto align-self-center">—</div>
                <div class="col">
                    <input type="date" name="end_expiration_date" class="form-control form-control-sm"
                           value="{{ end_expiration_date }}">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Скрытые поля для сортировки -->
    <input type="hidden" name="sort" value="{{ sort }}">
    <input type="hidden" name="direction" value="{{ direction }}">
    <input type="hidden" name="page" value="1">
    
</form>

<style>
/* Стили для правильного отображения фильтров */
.form-label.small {
    font-size: 0.875rem;
    font-weight: 500;
}
</style>

<div class="table-responsive">
    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <!-- Заголовки с сортировкой -->
            <tr>
                <th>
                    <a href="#" class="sort-link" data-sort="batch_number">
                        Номер партии
                        {% if sort == 'batch_number' %}
                            {% if direction == 'asc' %}↑{% else %}↓{% endif %}
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a href="#" class="sort-link" data-sort="nomenclature__name">
                        Номенклатура
                        {% if sort == 'nomenclature__name' %}
                            {% if direction == 'asc' %}↑{% else %}↓{% endif %}
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a href="#" class="sort-link" data-sort="quantity">
                        Количество
                        {% if sort == 'quantity' %}
                            {% if direction == 'asc' %}↑{% else %}↓{% endif %}
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a href="#" class="sort-link" data-sort="production_date">
                        Дата производства
                        {% if sort == 'production_date' %}
                            {% if direction == 'asc' %}↑{% else %}↓{% endif %}
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a href="#" class="sort-link" data-sort="reception_date">
                        Дата приёмки
                        {% if sort == 'reception_date' %}
                            {% if direction == 'asc' %}↑{% else %}↓{% endif %}
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a href="#" class="sort-link" data-sort="expiration_date">
                        Срок годности
                        {% if sort == 'expiration_date' %}
                            {% if direction == 'asc' %}↑{% else %}↓{% endif %}
                        {% endif %}
                    </a>
                </th>
                <th>Действие</th>
            </tr>
        </thead>

        <tbody>
            {% for batch in batches %}
            <tr>
                <td>{{ batch.batch_number }}</td>
                <td>{{ batch.nomenclature.name }}</td>
                <td>{{ batch.quantity }}</td>
                <td>{{ batch.production_date }}</td>
                <td>{{ batch.reception_date }}</td>
                <td>{{ batch.expiration_date }}</td>
                <td>
                    {% if not batch.reception_date %}
                    <div class="d-flex gap-1 flex-wrap">
                        <!-- Добавлена кнопка редактирования -->
                        <a href="{% url 'productbatch_edit' batch.id %}" class="btn btn-sm btn-warning">
                            Редактировать
                        </a>
                        <form method="post" action="{% url 'productbatch_receive' batch.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-primary">Принять</button>
                        </form>
                    </div>
                    {% else %}
                    <span class="text-success">Принята</span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center">Ничего не найдено</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Пагинация -->
<nav>
  <ul class="pagination">
    {% if batches.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ batches.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if sort and sort != 'production_date' %}&sort={{ sort }}{% endif %}{% if direction and direction != 'asc' %}&direction={{ direction }}{% endif %}{% if start_production_date %}&start_production_date={{ start_production_date }}{% endif %}{% if end_production_date %}&end_production_date={{ end_production_date }}{% endif %}{% if start_reception_date %}&start_reception_date={{ start_reception_date }}{% endif %}{% if end_reception_date %}&end_reception_date={{ end_reception_date }}{% endif %}{% if start_expiration_date %}&start_expiration_date={{ start_expiration_date }}{% endif %}{% if end_expiration_date %}&end_expiration_date={{ end_expiration_date }}{% endif %}">
           Назад
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Назад</span></li>
    {% endif %}

    {% for num in batches.paginator.page_range %}
      {% if batches.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% else %}
        <li class="page-item">
          <a class="page-link"
             href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if sort and sort != 'production_date' %}&sort={{ sort }}{% endif %}{% if direction and direction != 'asc' %}&direction={{ direction }}{% endif %}{% if start_production_date %}&start_production_date={{ start_production_date }}{% endif %}{% if end_production_date %}&end_production_date={{ end_production_date }}{% endif %}{% if start_reception_date %}&start_reception_date={{ start_reception_date }}{% endif %}{% if end_reception_date %}&end_reception_date={{ end_reception_date }}{% endif %}{% if start_expiration_date %}&start_expiration_date={{ start_expiration_date }}{% endif %}{% if end_expiration_date %}&end_expiration_date={{ end_expiration_date }}{% endif %}">
             {{ num }}
          </a>
        </li>
      {% endif %}
    {% endfor %}

    {% if batches.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ batches.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if sort and sort != 'production_date' %}&sort={{ sort }}{% endif %}{% if direction and direction != 'asc' %}&direction={{ direction }}{% endif %}{% if start_production_date %}&start_production_date={{ start_production_date }}{% endif %}{% if end_production_date %}&end_production_date={{ end_production_date }}{% endif %}{% if start_reception_date %}&start_reception_date={{ start_reception_date }}{% endif %}{% if end_reception_date %}&end_reception_date={{ end_reception_date }}{% endif %}{% if start_expiration_date %}&start_expiration_date={{ start_expiration_date }}{% endif %}{% if end_expiration_date %}&end_expiration_date={{ end_expiration_date }}{% endif %}">
           Вперед
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Вперед</span></li>
    {% endif %}
  </ul>
</nav>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('filter-form');
    
    // Обработка сортировки
    document.querySelectorAll('.sort-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const sortField = this.dataset.sort;
            const currentSort = document.querySelector('[name="sort"]').value;
            const currentDirection = document.querySelector('[name="direction"]').value;
            
            if (currentSort === sortField) {
                // Меняем направление, если кликаем по тому же полю
                document.querySelector('[name="direction"]').value = 
                    currentDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // Иначе устанавливаем новое поле и направление по умолчанию
                document.querySelector('[name="sort"]').value = sortField;
                document.querySelector('[name="direction"]').value = 'asc';
            }
            
            // Сбрасываем страницу на первую при сортировке
            document.querySelector('[name="page"]').value = 1;
            form.submit();
        });
    });
    
    // Синхронизация дат
    function syncDates(startName, endName) {
        const start = document.querySelector(`[name="${startName}"]`);
        const end = document.querySelector(`[name="${endName}"]`);
        
        if (start && end) {
            start.addEventListener('change', () => {
                if (end.value && start.value > end.value) {
                    end.value = start.value;
                }
            });
            
            end.addEventListener('change', () => {
                if (start.value && end.value < start.value) {
                    start.value = end.value;
                }
            });
        }
    }
    
    syncDates('start_production_date', 'end_production_date');
    syncDates('start_reception_date', 'end_reception_date');
    syncDates('start_expiration_date', 'end_expiration_date');
});
</script>
{% endblock %}